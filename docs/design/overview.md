# 設計概要

## 背景と動機

Zettelkasten ワークフローにおいて、ノートを書くだけでなく定期的に見直し・改善することが知識の定着に不可欠である。既存のツールにはいくつかの課題がある:

- **org-roam-review** — Emacs + org-roam に密結合しており、他のエディタでは使えない。SRS アルゴリズムも遅延日数やリンク構造を考慮しない
- **obsidian-sr (Spaced Repetition)** — Obsidian プラグインとしてのみ動作し、フラッシュカード中心の設計でノート単位の成熟管理は副次的な機能にとどまる

sprout はこれらの制約を解消するため、**CLI ツール + エディタプラグイン** という構成を採用した。CLI はエディタに依存しない純粋なデータ変換ツールとして設計し、エディタ固有のワークフロー（ノート選択、バッファリロード、フック）はプラグイン層に委ねる。

## Evergreen Notes の方法論

[Evergreen Notes](https://notes.andymatuschak.org/Evergreen_notes) は Andy Matuschak が提唱する概念で、以下の性質を持つノートを目指す:

- **原子的** — 1 つのノートは 1 つの概念を扱う
- **概念指向** — トピックや出典ではなく、概念を軸に書く
- **密にリンクされた** — ノート同士が `[[wiki-link]]` で接続され、知識のネットワークを形成する
- **繰り返し発展する** — 一度書いて終わりではなく、定期的に見直し改善する

この方法論は Niklas Luhmann の Zettelkasten と共通する基盤を持つ。Zettelkasten が原子的なノートとリンクによる知識構造を重視するのに対し、Evergreen Notes はさらにノートの「成熟」という時間軸を強調する。

## sprout のアプローチ

sprout は間隔反復（SRS）を使い、ノートの成熟を 3 段階でモデル化する:

1. **seedling** (種) — 新しいノート。短いインターバル（1 日〜）で頻繁にレビューし、内容を練り上げる
2. **budding** (芽) — 成長中のノート。リンクが増え、文脈が明確になりつつある。中程度のインターバルでレビュー
3. **evergreen** (常緑) — 十分に成熟したノート。長いインターバル（最大 90 日）で定期的に再訪する

成熟度の遷移は自動ではなく、ユーザーが `sprout promote` で明示的に行う。これは、ノートの質の判断は人間が行うべきという設計判断による。SRS が管理するのはレビューのタイミングであり、成熟度はユーザーの意思で決定する。

### SRS アルゴリズムの特徴

SM-2 をベースに、Zettelkasten ワークフローに適した拡張を加えている:

- **遅延日数の考慮** — 予定日を過ぎてレビューした場合、理解度（hard/good/easy）に応じて遅延分をインターバルに反映する
- **リンクファクター** — `[[wiki-link]]` の数に応じて ease を調整する。リンクが多いノートは文脈が豊富で思い出しやすいため、インターバルを適切に延長する
- **負荷分散** — ファジングにより、特定の日にレビューが集中するのを防ぐ

## アーキテクチャ概観

sprout は **CLI（データ変換層）** と **エディタプラグイン（ワークフロー層）** を明確に分離する:

```
┌─────────────────────────────┐
│  エディタプラグイン層        │
│  (sprout.kak / 将来: nvim)  │
│  - ノート選択 UI             │
│  - バッファリロード          │
│  - User hook (ワークフロー)  │
└──────────┬──────────────────┘
           │ シェル呼び出し + JSON
┌──────────▼──────────────────┐
│  sprout CLI                  │
│  - フロントマター読み書き    │
│  - SRS 計算                  │
│  - vault スキャン            │
│  - human / JSON 出力         │
└──────────┬──────────────────┘
           │ ファイル I/O
┌──────────▼──────────────────┐
│  Markdown ファイル           │
│  (YAML frontmatter)         │
└─────────────────────────────┘
```

**CLI の責務:**
- YAML フロントマターのパース・書き戻し（既存の書式を保持する文字列操作方式）
- SRS アルゴリズムの計算（ease、interval、next_review）
- vault 全体のスキャンとフィルタリング
- テンプレートの読み込みと変数展開（ノート新規作成時）
- human-readable / JSON 形式での出力

**エディタプラグインの責務:**
- レビュー対象ノートの選択 UI（Kakoune の `menu` コマンド等）
- コマンド実行後のバッファリロード
- `trigger-user-hook` によるワークフロー拡張（自動 git commit、次ノートへの自動遷移等）

この分離により、CLI は純粋なデータ変換ツールとしてテスト・保守が容易になり、エディタプラグインは各エディタの流儀に従って自由に実装できる。

## 設計ドキュメントへの案内

各設計ドキュメントの位置付けと、推奨する読み順を示す。

### 基礎（まず読むべき）

1. **[frontmatter.md](frontmatter.md)** — sprout が管理するデータの形式。YAML フロントマターのフィールド定義、パース・書き戻しの方針
2. **[algorithm.md](algorithm.md)** — SRS アルゴリズムの詳細。ease/interval 計算、リンクファクター、負荷分散
3. **[cli.md](cli.md)** — 8 つのコマンドの仕様、Clap 構造、JSON 出力形式、ソースファイル構成

### 環境・統合

4. **[config.md](config.md)** — 設定ファイルの仕様と vault パスの解決順序
5. **[kakoune-plugin.md](kakoune-plugin.md)** — Kakoune プラグインの実装、User hook によるワークフロー拡張
6. **[nix-packaging.md](nix-packaging.md)** — Nix Flake パッケージング、dotfiles への統合方法

### 参考

7. **[feature-coverage.md](feature-coverage.md)** — org-roam-review / obsidian-sr との機能比較、v0.1 カバー率、将来のロードマップ
